# environment setup
language: swift
os: osx
osx_image: xcode11.4

cache:
    bundler: true
    cocoapods: true
    directories:
      - "./vendor/bundle"

before_install:
    # Make sure we use the bundler version that is provided in the Gemfile.lock file
  - gem install bundler -v "$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -n 1)"

  # install dependencies
install:
  - bundle config set path 'vendor/bundle'
  - bundle install
  - bundle exec pod install

stages:
  # Test stage
  # Allow only if the type is a pull request and the branch is 'feature/...'
  - name: Test
    if: type = pull_request AND branch IN (develop, master)
  # Deploy new release stage
  # Allow only if the type is a PR and the branch is 'release/...'
  - name: Release
    if: type = pull_request AND branch = master
  # Deploy docs stage
  # Allow only if we push to master
  # TODO: Add check for: commit_message =~ ^[Release].*$
  - name: Deploy Documentation
    if: type = push AND branch = master



# jobs and stages to run
jobs:
  include:
    ###################### master ######################
    ### Docs deployment
    - stage: Deploy Documentation
      name: "Deploy iOS App Documentation from master to GitHub Pages"
      script:
        - bundle exec fastlane generate_docs
      after_failure:
        # Sleep to recover full logs
        - sleep 4
        - find /var/folders/z3 -name '*.log' -exec cat {} \;
      deploy:
        provider:     pages
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        keep-history: true
        local-dir:    docs/src

    ### Tests
    - stage: Test
      name: "UI & Unit tests"
      script:
        - bundle exec fastlane tests
      after_failure:
        - cat /Users/travis/Library/Developer/Xcode/DerivedData/Betterpick-cswmbpqoqkjrbsetljjetwhmkdcr/Build/Intermediates.noindex/Betterpick.build/Debug-iphonesimulator/Betterpick.build/Script-8908844F24449EA40080CCBF.sh

    ### New Release Deployment
    - stage: Release
      ## Screenshots
      script:
        - bundle exec fastlane deploy_screenshots
      name: "Generate Screenshots"
      ## TF Upload
    - script:
        - bundle exec fastlane deploy_beta_mocks
      name: "TestFlight Upload"
      ## Documentation generation
    - script:
        - bundle exec fastlane generate_and_commit_documentation
      name: "Generate Documentation"
      